<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#1e40af" />
    <meta name="description" content="Anonymous Academic Peer Review - Confidential paper evaluation system using Zama FHE protocol" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <title>Anonymous Academic Peer Review v2.5 - Manual Deploy</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #f8fafc;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            border-bottom: 1px solid #475569;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .header p {
            font-size: 1.1rem;
            color: #94a3b8;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .wallet-section {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .wallet-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.connected {
            background: #22c55e;
        }

        .btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .btn:disabled {
            background: #64748b;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .card {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .card h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #f1f5f9;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #e2e8f0;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #475569;
            border-radius: 8px;
            background: rgba(30, 41, 59, 0.8);
            color: #f8fafc;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .evaluation-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .option-button {
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid #475569;
            border-radius: 8px;
            padding: 1rem;
            color: #f8fafc;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .option-button:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .option-button.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        .submissions-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .submission-item {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .submission-item:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .submission-item.reviewed {
            border-color: #059669;
            background: rgba(5, 150, 105, 0.05);
        }

        .submission-item.reviewed:hover {
            border-color: #059669;
            background: rgba(5, 150, 105, 0.1);
        }

        .submission-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .submission-title {
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 0.5rem;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: #94a3b8;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #475569;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .alert.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #22c55e;
            color: #86efac;
        }

        .alert.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            color: #fca5a5;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .evaluation-options {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Anonymous Academic Peer Review</h1>
            <p>Confidential paper evaluation system using Zama FHE protocol for complete privacy and anonymity in academic peer review process</p>
        </header>

        <div class="wallet-section">
            <div class="wallet-status">
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="walletStatus">Not Connected</span>
                </div>
                <button class="btn" id="connectWallet">Connect Wallet</button>
            </div>
            <div id="walletAddress" class="hidden">
                <p><strong>Address:</strong> <span id="userAddress"></span></p>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>Submit Paper for Review</h2>
                <form id="submitForm">
                    <div class="form-group">
                        <label for="paperTitle">Paper Title</label>
                        <input type="text" id="paperTitle" required placeholder="Enter paper title">
                    </div>
                    
                    <div class="form-group">
                        <label for="paperAbstract">Abstract</label>
                        <textarea id="paperAbstract" required placeholder="Enter paper abstract"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="paperCategory">Research Category</label>
                        <select id="paperCategory" required>
                            <option value="">Select category</option>
                            <option value="computer-science">Computer Science</option>
                            <option value="mathematics">Mathematics</option>
                            <option value="physics">Physics</option>
                            <option value="biology">Biology</option>
                            <option value="chemistry">Chemistry</option>
                            <option value="medicine">Medicine</option>
                            <option value="engineering">Engineering</option>
                            <option value="social-sciences">Social Sciences</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn" id="submitBtn">Submit Paper</button>
                </form>
            </div>

            <div class="card">
                <h2>Review Papers</h2>
                <div id="papersList">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading papers for review...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="reviewCard" style="display: none;">
            <h2>Peer Review Evaluation</h2>
            <div id="reviewContent">
                <div class="form-group">
                    <label>Paper Quality Assessment</label>
                    <div class="evaluation-options">
                        <div class="option-button" data-quality="excellent">
                            <strong>Excellent</strong><br>
                            <small>Outstanding contribution</small>
                        </div>
                        <div class="option-button" data-quality="good">
                            <strong>Good</strong><br>
                            <small>Solid research</small>
                        </div>
                        <div class="option-button" data-quality="acceptable">
                            <strong>Acceptable</strong><br>
                            <small>Minor revisions needed</small>
                        </div>
                        <div class="option-button" data-quality="poor">
                            <strong>Poor</strong><br>
                            <small>Major issues</small>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Recommendation</label>
                    <div class="evaluation-options">
                        <div class="option-button" data-recommendation="accept">
                            <strong>Accept</strong><br>
                            <small>Ready for publication</small>
                        </div>
                        <div class="option-button" data-recommendation="reject">
                            <strong>Reject</strong><br>
                            <small>Not suitable</small>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="reviewComments">Confidential Review Comments</label>
                    <textarea id="reviewComments" placeholder="Your confidential review comments (encrypted on blockchain)"></textarea>
                </div>

                <button type="button" class="btn" id="submitReviewBtn">Submit Review</button>
                <button type="button" class="btn" id="cancelReviewBtn" style="background: #64748b; margin-left: 1rem;">Cancel</button>
            </div>
        </div>

        <div id="alerts"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@6.8.0/dist/ethers.umd.min.js"></script>
    
    <script>
        // Contract configuration
        const CONTRACT_ADDRESS = '0xBeb1a83923072478B2Ec4451Fb9BEb9b354B25ca';
        const CONTRACT_ABI = [
            {
                "inputs": [
                    {"internalType": "string", "name": "_title", "type": "string"},
                    {"internalType": "string", "name": "_paperAbstract", "type": "string"},
                    {"internalType": "string", "name": "_category", "type": "string"}
                ],
                "name": "submitPaper",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_paperId", "type": "uint256"},
                    {"internalType": "bool", "name": "_recommendation", "type": "bool"},
                    {"internalType": "uint8", "name": "_quality", "type": "uint8"},
                    {"internalType": "string", "name": "_comments", "type": "string"}
                ],
                "name": "submitReview",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getPapersForReview",
                "outputs": [
                    {
                        "components": [
                            {"internalType": "uint256", "name": "id", "type": "uint256"},
                            {"internalType": "string", "name": "title", "type": "string"},
                            {"internalType": "string", "name": "paperAbstract", "type": "string"},
                            {"internalType": "string", "name": "category", "type": "string"},
                            {"internalType": "address", "name": "author", "type": "address"},
                            {"internalType": "uint256", "name": "timestamp", "type": "uint256"}
                        ],
                        "internalType": "struct AcademicReview.Paper[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // Global variables
        let provider, signer, contract, userAddress;
        let selectedQuality = null;
        let selectedRecommendation = null;
        let currentReviewPaperId = null;
        
        // Track demo reviews locally (reset on page reload)
        let demoReviewedPapers = new Set();

        // DOM elements
        const connectWalletBtn = document.getElementById('connectWallet');
        const statusDot = document.getElementById('statusDot');
        const walletStatus = document.getElementById('walletStatus');
        const walletAddress = document.getElementById('walletAddress');
        const userAddressSpan = document.getElementById('userAddress');
        const submitForm = document.getElementById('submitForm');
        const papersList = document.getElementById('papersList');
        const reviewCard = document.getElementById('reviewCard');
        const alertsContainer = document.getElementById('alerts');

        // Initialize app
        async function init() {
            // Always load demo papers first
            loadDemoPapers();
            
            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMask is installed');
                
                // Check if already connected
                const accounts = await window.ethereum.request({method: 'eth_accounts'});
                if (accounts.length > 0) {
                    await connectWallet();
                }
            } else {
                showAlert('Please install MetaMask to use this application', 'error');
            }
        }

        // Store demo papers globally for consistent access
        const globalDemoPapers = [
            {
                id: 1,
                title: "Deep Learning Applications in Medical Diagnosis",
                paperAbstract: "This paper explores the application of deep learning techniques in medical diagnosis, focusing on image recognition and pattern analysis for early disease detection. Our research demonstrates significant improvements in diagnostic accuracy compared to traditional methods.",
                category: "computer-science",
                timestamp: Math.floor(Date.now() / 1000) - 86400, // 1 day ago
                isDemo: true
            },
            {
                id: 2,
                title: "Quantum Computing Algorithms for Cryptography",
                paperAbstract: "We present novel quantum algorithms that enhance cryptographic security while maintaining computational efficiency. This work addresses current vulnerabilities in classical encryption methods and proposes quantum-resistant solutions.",
                category: "computer-science",
                timestamp: Math.floor(Date.now() / 1000) - 172800, // 2 days ago
                isDemo: true
            },
            {
                id: 3,
                title: "Climate Change Impact on Ocean Ecosystems",
                paperAbstract: "A comprehensive study on how rising ocean temperatures affect marine biodiversity. Our findings reveal significant changes in species distribution and ecosystem stability over the past decade.",
                category: "biology",
                timestamp: Math.floor(Date.now() / 1000) - 259200, // 3 days ago
                isDemo: true
            },
            {
                id: 4,
                title: "Machine Learning in Financial Risk Assessment",
                paperAbstract: "This research presents innovative machine learning models for predicting financial risks and market volatility. Our approach combines traditional statistical methods with modern deep learning techniques to achieve superior prediction accuracy.",
                category: "computer-science",
                timestamp: Math.floor(Date.now() / 1000) - 345600, // 4 days ago
                isDemo: true
            },
            {
                id: 5,
                title: "Renewable Energy Storage Solutions",
                paperAbstract: "A comprehensive analysis of next-generation battery technologies and their applications in renewable energy storage. This study evaluates efficiency, cost-effectiveness, and environmental impact of various storage solutions.",
                category: "engineering",
                timestamp: Math.floor(Date.now() / 1000) - 432000, // 5 days ago
                isDemo: true
            },
            {
                id: 6,
                title: "Neural Networks for Natural Language Processing",
                paperAbstract: "An investigation into transformer architectures and their applications in multilingual text understanding. This work proposes novel attention mechanisms that improve performance on low-resource languages and cross-lingual transfer tasks.",
                category: "computer-science",
                timestamp: Math.floor(Date.now() / 1000) - 518400, // 6 days ago
                isDemo: true
            },
            {
                id: 7,
                title: "Genetic Engineering in Agricultural Sustainability",
                paperAbstract: "This research examines the role of CRISPR technology in developing drought-resistant crops. Our findings demonstrate significant yield improvements in arid environments while maintaining nutritional value and genetic diversity.",
                category: "biology",
                timestamp: Math.floor(Date.now() / 1000) - 604800, // 7 days ago
                isDemo: true
            },
            {
                id: 8,
                title: "Blockchain-Based Supply Chain Transparency",
                paperAbstract: "A novel framework for implementing blockchain technology in global supply chains to enhance traceability and reduce fraud. This study presents real-world applications and cost-benefit analyses across multiple industries.",
                category: "computer-science",
                timestamp: Math.floor(Date.now() / 1000) - 691200, // 8 days ago
                isDemo: true
            },
            {
                id: 9,
                title: "Microplastic Pollution in Freshwater Systems",
                paperAbstract: "A comprehensive analysis of microplastic contamination in rivers and lakes worldwide. Our research identifies sources, transport mechanisms, and potential health impacts on aquatic organisms and human populations.",
                category: "biology",
                timestamp: Math.floor(Date.now() / 1000) - 777600, // 9 days ago
                isDemo: true
            },
            {
                id: 10,
                title: "Smart Grid Integration with IoT Devices",
                paperAbstract: "This paper presents innovative approaches to integrating Internet of Things devices with smart grid infrastructure. We demonstrate improved energy efficiency and grid stability through real-time monitoring and predictive analytics.",
                category: "engineering",
                timestamp: Math.floor(Date.now() / 1000) - 864000, // 10 days ago
                isDemo: true
            }
        ];

        // Load demo papers (always visible)
        function loadDemoPapers() {
            console.log('=== loadDemoPapers called ===');
            console.log('globalDemoPapers.length:', globalDemoPapers.length);
            console.log('First paper:', globalDemoPapers[0]);
            
            const papersList = document.getElementById('papersList');
            console.log('papersList element:', papersList);
            
            if (!papersList) {
                console.error('papersList element not found!');
                return;
            }
            
            // Clear any existing content first
            papersList.innerHTML = '';
            
            // Use the unified update function
            updatePaperDisplayStatus();
            
            console.log('=== loadDemoPapers completed ===');
        }

        // Deploy all papers to blockchain (manual deployment)
        async function deployAllPapers() {
            try {
                if (!contract) {
                    throw new Error('Please connect your wallet first');
                }

                showAlert('üöÄ Starting deployment of all papers to blockchain...', 'success');
                console.log('=== Starting manual deployment of all papers ===');

                // Check current papers on blockchain
                let existingPapers = [];
                try {
                    existingPapers = await contract.getPapersForReview();
                    console.log('Current papers on blockchain:', existingPapers.length);
                } catch (error) {
                    console.log('No existing papers found');
                }

                // Deploy each paper
                for (let i = 0; i < globalDemoPapers.length; i++) {
                    const paper = globalDemoPapers[i];
                    
                    try {
                        console.log(`Deploying paper ${i + 1}:`, paper.title);
                        showAlert(`üìù Deploying paper ${i + 1}/${globalDemoPapers.length}: "${paper.title.substring(0, 40)}..."`, 'success');
                        
                        const tx = await contract.submitPaper(
                            paper.title,
                            paper.paperAbstract,
                            paper.category
                        );
                        
                        console.log(`Transaction sent for paper ${i + 1}:`, tx.hash);
                        showAlert(`‚è≥ Waiting for confirmation of paper ${i + 1}...`, 'success');
                        
                        const receipt = await tx.wait();
                        console.log(`Paper ${i + 1} confirmed in block:`, receipt.blockNumber);
                        showAlert(`‚úÖ Paper ${i + 1} deployed successfully!`, 'success');
                        
                    } catch (error) {
                        console.error(`Error deploying paper ${i + 1}:`, error);
                        showAlert(`‚ùå Error deploying paper ${i + 1}: ${error.message}`, 'error');
                        continue;
                    }
                }

                // Get the deployed papers and update IDs
                try {
                    showAlert('üîÑ Retrieving deployed papers and updating IDs...', 'success');
                    const deployedPapers = await contract.getPapersForReview();
                    console.log('Total deployed papers:', deployedPapers.length);
                    
                    // Update preset papers with real blockchain IDs
                    for (let i = 0; i < Math.min(deployedPapers.length, globalDemoPapers.length); i++) {
                        const realId = Number(deployedPapers[i].id);
                        globalDemoPapers[i].id = realId;
                        globalDemoPapers[i].realId = realId;
                        console.log(`Updated paper "${globalDemoPapers[i].title}" with blockchain ID: ${realId}`);
                    }
                    
                    showAlert(`üéâ Deployment complete! All ${globalDemoPapers.length} papers are now on blockchain and ready for reviews.`, 'success');
                    
                } catch (error) {
                    console.error('Error retrieving deployed papers:', error);
                    showAlert('Papers deployed but error retrieving IDs: ' + error.message, 'error');
                }

                // Update display
                updatePaperDisplayStatus();
                console.log('=== Deployment process completed ===');

            } catch (error) {
                console.error('Error in deployAllPapers:', error);
                showAlert('Deployment failed: ' + error.message, 'error');
            }
        }

        // Ensure papers exist on blockchain
        async function ensurePapersExist() {
            try {
                console.log('Checking if papers exist on blockchain...');
                
                // Try to get existing papers
                let existingPapers = [];
                try {
                    existingPapers = await contract.getPapersForReview();
                    console.log('Found', existingPapers.length, 'existing papers on blockchain');
                } catch (error) {
                    console.log('Error getting papers, assuming none exist:', error);
                }
                
                if (existingPapers.length >= globalDemoPapers.length) {
                    // Papers already exist, update preset papers with real IDs
                    console.log('Papers already exist, updating preset papers with real IDs');
                    for (let i = 0; i < Math.min(existingPapers.length, globalDemoPapers.length); i++) {
                        globalDemoPapers[i].id = Number(existingPapers[i].id);
                        globalDemoPapers[i].realId = Number(existingPapers[i].id);
                    }
                    showAlert('Papers found on blockchain! Ready for reviews.', 'success');
                    updatePaperDisplayStatus();
                    return;
                }
                
                // Need to create papers on blockchain
                showAlert('Creating papers on blockchain for the first time...', 'success');
                
                for (let i = 0; i < globalDemoPapers.length; i++) {
                    const paper = globalDemoPapers[i];
                    
                    try {
                        showAlert(`Submitting paper ${i + 1} of ${globalDemoPapers.length}: ${paper.title.substring(0, 30)}...`, 'success');
                        
                        const tx = await contract.submitPaper(
                            paper.title,
                            paper.paperAbstract,
                            paper.category
                        );
                        
                        await tx.wait();
                        console.log(`Paper ${i + 1} submitted successfully:`, paper.title);
                        
                    } catch (error) {
                        console.error(`Error submitting paper ${i + 1}:`, error);
                        showAlert(`Error submitting paper ${i + 1}: ${error.message}`, 'error');
                    }
                }
                
                // After creating papers, get the real IDs and update preset papers
                try {
                    const newPapers = await contract.getPapersForReview();
                    console.log('Retrieved new papers with real IDs:', newPapers.length);
                    
                    // Update preset papers with real blockchain IDs
                    for (let i = 0; i < Math.min(newPapers.length, globalDemoPapers.length); i++) {
                        globalDemoPapers[i].id = Number(newPapers[i].id);
                        globalDemoPapers[i].realId = Number(newPapers[i].id);
                        console.log(`Updated paper ${i + 1} with real ID: ${globalDemoPapers[i].id}`);
                    }
                } catch (error) {
                    console.error('Error getting real paper IDs:', error);
                }
                
                showAlert('All papers created on blockchain! Preset papers now use real blockchain IDs.', 'success');
                updatePaperDisplayStatus();
                
            } catch (error) {
                console.error('Error ensuring papers exist:', error);
                showAlert('Error setting up papers: ' + error.message, 'error');
                // Still show papers for display, even if creation failed
                updatePaperDisplayStatus();
            }
        }

        // Connect wallet with Sepolia network support
        async function connectWallet() {
            try {
                if (typeof window.ethereum === "undefined") {
                    throw new Error("MetaMask is not installed. Please install MetaMask to continue.");
                }

                // Request account access
                await window.ethereum.request({method: "eth_requestAccounts"});
                
                // Create provider and signer
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();

                // Check current network
                const network = await provider.getNetwork();
                const sepoliaChainId = 11155111;

                if (Number(network.chainId) !== sepoliaChainId) {
                    try {
                        // Try to switch to Sepolia
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }], // Sepolia chain ID in hex
                        });
                    } catch (switchError) {
                        // If network doesn't exist, add it
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [
                                    {
                                        chainId: '0xaa36a7',
                                        chainName: 'Sepolia Testnet',
                                        nativeCurrency: {
                                            name: 'SepoliaETH',
                                            symbol: 'SEP',
                                            decimals: 18,
                                        },
                                        rpcUrls: ['https://sepolia.infura.io/v3/'],
                                        blockExplorerUrls: ['https://sepolia.etherscan.io/'],
                                    },
                                ],
                            });
                        } else {
                            throw switchError;
                        }
                    }

                    // Recreate provider after network change
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                }

                // Initialize contract
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // Update UI
                statusDot.className = 'status-dot connected';
                walletStatus.textContent = 'Connected to Sepolia';
                userAddressSpan.textContent = userAddress;
                walletAddress.classList.remove('hidden');
                connectWalletBtn.textContent = 'Connected';
                connectWalletBtn.disabled = true;

                console.log('Wallet connected:', userAddress);
                showAlert('Wallet connected successfully! Ready to deploy papers.', 'success');

                // Just update display, don't auto-deploy
                updatePaperDisplayStatus();

            } catch (error) {
                console.error('Error connecting wallet:', error);
                showAlert('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        // Submit paper
        async function submitPaper(title, abstract, category) {
            try {
                if (!contract) throw new Error('Please connect your wallet first');
                
                const tx = await contract.submitPaper(title, abstract, category);
                showAlert('Transaction submitted. Waiting for confirmation...', 'success');
                
                await tx.wait();
                showAlert('Paper submitted successfully!', 'success');
                
                // Clear form
                document.getElementById('submitForm').reset();
                
                // Reload papers
                await loadPapersForReview();
            } catch (error) {
                console.error('Error submitting paper:', error);
                showAlert('Failed to submit paper: ' + error.message, 'error');
            }
        }

        // Load papers for review (called after wallet connection)
        async function loadPapersForReview() {
            try {
                const papersList = document.getElementById('papersList');

                if (contract) {
                    // Try to load real papers from contract (excluding user's own papers)
                    const reviewablePapers = await contract.getPapersForReview();

                    // Always ensure demo papers are available as fallback
                    let papersToShow = [];
                    let hasRealPapers = false;

                    if (reviewablePapers.length > 0) {
                        // If there are real papers from blockchain, show them
                        papersToShow = reviewablePapers;
                        hasRealPapers = true;
                    }

                    // If no reviewable papers or few papers, also show demo papers for variety
                    if (reviewablePapers.length < 3) {
                        // Mix demo papers with real ones, but filter out any that might conflict
                        const demoToAdd = globalDemoPapers.filter(demo =>
                            !papersToShow.some(real => Number(real.id) === demo.id)
                        );
                        papersToShow = [...papersToShow, ...demoToAdd];
                    }

                    // If still no papers to show, show all demo papers
                    if (papersToShow.length === 0) {
                        papersToShow = globalDemoPapers;
                    }

                    displayPapers(papersToShow);

                    // Add appropriate notice
                    const notice = document.createElement('div');
                    notice.style.cssText = 'text-align: center; padding: 1rem; font-size: 0.9rem; border-top: 1px solid #475569; margin-top: 1rem;';

                    if (hasRealPapers) {
                        notice.style.color = '#059669';
                        notice.innerHTML = `
                            <p>‚úÖ Showing ${reviewablePapers.length} reviewable papers from blockchain + ${papersToShow.length - reviewablePapers.length} demo papers</p>
                            <p style="color: #64748b; font-size: 0.85rem; margin-top: 0.5rem;">
                                Reviews on blockchain papers will be encrypted with FHE!
                            </p>
                        `;
                    } else {
                        notice.style.color = '#94a3b8';
                        const hasDeployedPapers = globalDemoPapers.some(paper => paper.realId);
                        notice.innerHTML = `
                            <p>üìù Showing ${papersToShow.length} demo papers${hasDeployedPapers ? ' (some deployed to blockchain)' : ''}</p>
                            ${!hasDeployedPapers ? `
                                <button class="btn" onclick="deployAllPapers()" style="background: #059669; margin-top: 1rem;">
                                    üöÄ Deploy All Papers to Blockchain
                                </button>
                                <p style="color: #64748b; font-size: 0.85rem; margin-top: 0.5rem;">
                                    Deploy papers to blockchain for real encrypted reviews
                                </p>
                            ` : `
                                <p style="color: #64748b; font-size: 0.85rem; margin-top: 0.5rem;">
                                    Papers deployed! Submit your own papers to create more reviewable content.
                                </p>
                            `}
                        `;
                    }
                    papersList.appendChild(notice);
                } else {
                    // Fallback to demo papers if no contract
                    displayPapers(globalDemoPapers);

                    const notice = document.createElement('div');
                    notice.style.cssText = 'text-align: center; color: #94a3b8; padding: 1rem; font-size: 0.9rem; border-top: 1px solid #475569; margin-top: 1rem;';
                    notice.innerHTML = `üìù ${globalDemoPapers.length} demo papers available. Connect wallet to submit real blockchain transactions.`;
                    papersList.appendChild(notice);
                }
            } catch (error) {
                console.error('Error loading papers:', error);
                // Show demo papers as fallback when there's an error
                displayPapers(globalDemoPapers);

                const notice = document.createElement('div');
                notice.style.cssText = 'text-align: center; color: #ef4444; padding: 1rem; font-size: 0.9rem; border-top: 1px solid #475569; margin-top: 1rem;';
                notice.innerHTML = `‚ö†Ô∏è Error loading blockchain papers. Showing demo papers instead.`;
                papersList.appendChild(notice);
            }
        }

        // Create demo papers for testing
        async function createDemoPapers() {
            try {
                if (!contract) throw new Error('Please connect your wallet first');
                
                showAlert('Creating demo papers for testing...', 'success');
                
                const demoPapers = [
                    {
                        title: "Deep Learning Applications in Medical Diagnosis",
                        abstract: "This paper explores the application of deep learning techniques in medical diagnosis, focusing on image recognition and pattern analysis for early disease detection. Our research demonstrates significant improvements in diagnostic accuracy compared to traditional methods.",
                        category: "computer-science"
                    },
                    {
                        title: "Quantum Computing Algorithms for Cryptography", 
                        abstract: "We present novel quantum algorithms that enhance cryptographic security while maintaining computational efficiency. This work addresses current vulnerabilities in classical encryption methods and proposes quantum-resistant solutions.",
                        category: "computer-science"
                    },
                    {
                        title: "Climate Change Impact on Ocean Ecosystems",
                        abstract: "A comprehensive study on how rising ocean temperatures affect marine biodiversity. Our findings reveal significant changes in species distribution and ecosystem stability over the past decade.",
                        category: "biology"
                    }
                ];

                for (let i = 0; i < demoPapers.length; i++) {
                    const paper = demoPapers[i];
                    showAlert(`Submitting paper ${i + 1} of ${demoPapers.length}...`, 'success');
                    
                    const tx = await contract.submitPaper(
                        paper.title,
                        paper.abstract,
                        paper.category
                    );
                    
                    await tx.wait();
                    showAlert(`Paper ${i + 1} submitted successfully!`, 'success');
                }
                
                showAlert('All demo papers created! Reloading papers...', 'success');
                
                // Reload papers after creating them
                setTimeout(async () => {
                    await loadPapersForReview();
                }, 2000);
                
            } catch (error) {
                console.error('Error creating demo papers:', error);
                showAlert('Failed to create demo papers: ' + error.message, 'error');
            }
        }

        // Display papers
        function displayPapers(papers) {
            console.log('=== displayPapers called ===');
            console.log('Papers count:', papers.length);
            console.log('Papers array:', papers);
            
            const papersList = document.getElementById('papersList');
            console.log('papersList element in displayPapers:', papersList);
            
            if (!papersList) {
                console.error('ERROR: papersList element not found in displayPapers!');
                return;
            }
            
            if (papers.length === 0) {
                console.log('No papers to display');
                papersList.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 2rem;">No papers available for review</div>';
                return;
            }

            const papersHtml = papers.map(paper => {
                const paperId = Number(paper.id);
                const isReviewed = demoReviewedPapers.has(paperId);

                // Check if this is user's own paper (for real blockchain papers)
                const isOwnPaper = paper.author && userAddress &&
                    paper.author.toLowerCase() === userAddress.toLowerCase();

                // Determine review status and clickability
                let reviewStatus, clickable = true, cardClass = '';

                if (isOwnPaper) {
                    reviewStatus = '<span style="color: #f59e0b; font-size: 0.8rem;">üë§ Your Paper</span>';
                    clickable = false;
                    cardClass = 'own-paper';
                } else if (isReviewed) {
                    reviewStatus = '<span style="color: #059669; font-size: 0.8rem;">‚úÖ Reviewed</span>';
                    cardClass = 'reviewed';
                } else if (contract) {
                    reviewStatus = '<span style="color: #3b82f6; font-size: 0.8rem;">üìù Ready for review</span>';
                } else {
                    reviewStatus = '<span style="color: #94a3b8; font-size: 0.8rem;">üìù Connect wallet to review</span>';
                }

                console.log('Processing paper:', paperId, paper.title, 'isOwnPaper:', isOwnPaper);

                const clickHandler = clickable ? `onclick="startReview(${paperId})"` :
                    `onclick="showAlert('‚ùå You cannot review your own paper. Please select a different paper to review.', 'error')"`;

                return `
                    <div class="submission-item ${cardClass}" ${clickHandler} style="cursor: ${clickable ? 'pointer' : 'not-allowed'}; opacity: ${clickable ? '1' : '0.7'};">
                        <div class="submission-meta">
                            <span>Paper #${paperId}</span>
                            <span>${new Date(Number(paper.timestamp) * 1000).toLocaleDateString()}</span>
                        </div>
                        <div class="submission-title">${paper.title}</div>
                        <div style="color: #94a3b8; font-size: 0.9rem; margin-top: 0.5rem;">
                            Category: ${paper.category.charAt(0).toUpperCase() + paper.category.slice(1).replace('-', ' ')}
                        </div>
                        <div style="color: #64748b; font-size: 0.85rem; margin-top: 0.5rem; line-height: 1.4;">
                            ${paper.paperAbstract.substring(0, 150)}${paper.paperAbstract.length > 150 ? '...' : ''}
                        </div>
                        <div style="margin-top: 0.5rem;">
                            ${reviewStatus}
                        </div>
                        ${isOwnPaper ? '<div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem; font-style: italic;">Cannot review own papers</div>' : ''}
                    </div>
                `;
            }).join('');
            
            console.log('Generated HTML length:', papersHtml.length);
            papersList.innerHTML = papersHtml;
            console.log('=== displayPapers completed ===');
            console.log('Final papersList.innerHTML length:', papersList.innerHTML.length);
        }

        // Update paper display status after review
        function updatePaperDisplayStatus() {
            // Always display papers, update notice based on wallet status
            displayPapers(globalDemoPapers);
            
            // Add notice about papers
            const papersList = document.getElementById('papersList');
            const notice = document.createElement('div');
            notice.style.cssText = 'text-align: center; padding: 1rem; font-size: 0.9rem; border-top: 1px solid #475569; margin-top: 1rem;';
            
            if (contract) {
                // Check if papers have real IDs
                const hasRealIds = globalDemoPapers.some(paper => paper.realId);
                notice.style.color = '#059669';
                notice.innerHTML = `
                    <p>‚úÖ Wallet Connected - ${globalDemoPapers.length} papers available for review</p>
                    <p style="color: #64748b; font-size: 0.85rem; margin-top: 0.5rem;">
                        ${hasRealIds ? 
                            'Papers are now on blockchain! Reviews will be encrypted and submitted.' : 
                            'Papers ready for deployment to blockchain.'
                        }
                    </p>
                    <p style="color: #64748b; font-size: 0.8rem; margin-top: 0.25rem;">
                        Contract: ${CONTRACT_ADDRESS}
                    </p>
                    ${!hasRealIds ? `
                        <button class="btn" onclick="deployAllPapers()" style="background: #059669; margin-top: 1rem;">
                            üöÄ Deploy All Papers to Blockchain
                        </button>
                    ` : ''}
                `;
            } else {
                notice.style.color = '#94a3b8';
                notice.innerHTML = `üìù ${globalDemoPapers.length} papers available for review. Connect wallet to submit real blockchain transactions.`;
            }
            
            papersList.appendChild(notice);
        }

        // Start review process
        function startReview(paperId) {
            currentReviewPaperId = paperId;
            reviewCard.style.display = 'block';
            reviewCard.scrollIntoView({ behavior: 'smooth' });
            
            // Update review card header to show paper info
            const reviewHeader = document.querySelector('#reviewCard h2');
            if (reviewHeader) {
                reviewHeader.textContent = `Peer Review Evaluation - Paper #${paperId}`;
            }
        }

        // Submit review
        async function submitReview() {
            try {
                if (!selectedQuality || selectedRecommendation === null) {
                    throw new Error('Please complete all evaluation criteria');
                }
                if (!currentReviewPaperId) {
                    throw new Error('No paper selected for review');
                }

                if (!contract) {
                    throw new Error('Please connect your wallet first to submit reviews');
                }

                const comments = document.getElementById('reviewComments').value || "No additional comments";
                const qualityScore = getQualityScore(selectedQuality);

                console.log('Submitting review for paper ID:', currentReviewPaperId);
                console.log('Quality score:', qualityScore);
                console.log('Recommendation:', selectedRecommendation === 'accept');
                console.log('Comments:', comments);
                console.log('Contract address:', CONTRACT_ADDRESS);

                // First try to estimate gas to catch errors early
                try {
                    const gasEstimate = await contract.submitReview.estimateGas(
                        currentReviewPaperId,
                        selectedRecommendation === 'accept',
                        qualityScore,
                        comments
                    );
                    console.log('Gas estimate:', gasEstimate.toString());
                } catch (gasError) {
                    console.error('Gas estimation failed:', gasError);

                    // Handle specific revert reasons
                    if (gasError.reason) {
                        if (gasError.reason === 'Cannot review your own paper') {
                            throw new Error('‚ùå You cannot review your own paper. Please select a different paper to review.');
                        } else if (gasError.reason.includes('Already reviewed')) {
                            throw new Error('‚ùå You have already reviewed this paper. Each reviewer can only submit one review per paper.');
                        } else if (gasError.reason.includes('not active')) {
                            throw new Error('‚ùå This paper is no longer accepting reviews.');
                        } else if (gasError.reason.includes('Invalid paper ID')) {
                            throw new Error('‚ùå Invalid paper ID. Please refresh the page and try again.');
                        } else {
                            throw new Error('‚ùå ' + gasError.reason);
                        }
                    } else if (gasError.message.includes('already reviewed')) {
                        throw new Error('‚ùå You have already reviewed this paper');
                    } else if (gasError.message.includes('your own paper') || gasError.message.includes('Cannot review your own paper')) {
                        throw new Error('‚ùå You cannot review your own paper. Please select a different paper to review.');
                    } else if (gasError.message.includes('not active')) {
                        throw new Error('‚ùå This paper is no longer accepting reviews');
                    } else if (gasError.message.includes('Invalid paper ID')) {
                        throw new Error('‚ùå Invalid paper ID - please refresh the page');
                    } else if (gasError.code === 'CALL_EXCEPTION') {
                        throw new Error('‚ùå Transaction would fail - check if you have already reviewed this paper or if it belongs to you');
                    } else {
                        throw new Error('‚ùå Transaction validation failed: ' + gasError.message);
                    }
                }

                // Submit review to blockchain with proper gas settings
                const tx = await contract.submitReview(
                    currentReviewPaperId,
                    selectedRecommendation === 'accept',
                    qualityScore,
                    comments,
                    {
                        gasLimit: 500000 // Set a reasonable gas limit
                    }
                );

                showAlert('Review submitted to blockchain. Waiting for confirmation...', 'success');
                console.log('Transaction hash:', tx.hash);

                await tx.wait();
                showAlert(`Review for Paper #${currentReviewPaperId} confirmed! Your evaluation is encrypted on blockchain.`, 'success');

                // Track this paper as reviewed
                demoReviewedPapers.add(currentReviewPaperId);

                // Reset review form
                resetReviewForm();

                // Update papers display to show reviewed status
                updatePaperDisplayStatus();

            } catch (error) {
                console.error('Error submitting review:', error);
                let errorMsg = error.message;

                // Provide more specific error messages
                if (error.message.includes('already reviewed')) {
                    errorMsg = 'You have already reviewed this paper';
                } else if (error.message.includes('your own paper')) {
                    errorMsg = 'You cannot review your own paper';
                } else if (error.message.includes('not active')) {
                    errorMsg = 'This paper is no longer accepting reviews';
                } else if (error.message.includes('Invalid paper ID')) {
                    errorMsg = 'Invalid paper ID - please try refreshing the page';
                } else if (error.message.includes('Connect your wallet')) {
                    errorMsg = 'Please connect your wallet first';
                } else if (error.code === 'CALL_EXCEPTION') {
                    errorMsg = 'Transaction failed - you may have already reviewed this paper or it may be your own paper';
                } else if (error.message.includes('missing revert data')) {
                    errorMsg = 'Transaction failed - please check if you have already reviewed this paper';
                } else if (error.message.includes('Transaction validation failed')) {
                    errorMsg = error.message;
                }

                showAlert('Failed to submit review: ' + errorMsg, 'error');
            }
        }

        // Get quality score
        function getQualityScore(quality) {
            const scores = {
                'excellent': 4,
                'good': 3,
                'acceptable': 2,
                'poor': 1
            };
            return scores[quality] || 1;
        }

        // Reset review form
        function resetReviewForm() {
            selectedQuality = null;
            selectedRecommendation = null;
            currentReviewPaperId = null;
            reviewCard.style.display = 'none';
            document.getElementById('reviewComments').value = '';
            
            // Remove selected state from all buttons
            document.querySelectorAll('.option-button').forEach(btn => {
                btn.classList.remove('selected');
            });
        }

        // Show alert
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alertsContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Event listeners
        connectWalletBtn.addEventListener('click', connectWallet);

        submitForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('paperTitle').value;
            const abstract = document.getElementById('paperAbstract').value;
            const category = document.getElementById('paperCategory').value;
            await submitPaper(title, abstract, category);
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('option-button')) {
                const parent = e.target.parentElement;
                
                // Remove selected state from siblings
                parent.querySelectorAll('.option-button').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // Add selected state to clicked button
                e.target.classList.add('selected');
                
                // Store selection
                if (e.target.dataset.quality) {
                    selectedQuality = e.target.dataset.quality;
                } else if (e.target.dataset.recommendation) {
                    selectedRecommendation = e.target.dataset.recommendation;
                }
            }
        });

        document.getElementById('submitReviewBtn').addEventListener('click', submitReview);
        document.getElementById('cancelReviewBtn').addEventListener('click', resetReviewForm);

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>